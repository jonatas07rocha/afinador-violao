<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afinador de Violão</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN for audio synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden; /* Prevent scroll during flip */
        }
        .flip-container {
            perspective: 1000px; /* For 3D effect */
            width: 100%;
            max-width: 480px;
            height: 600px; /* Fixed height for the flip card */
            position: relative;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        .flip-container.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
            background-color: #2d3748; /* Darker blue-gray */
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Distribute content vertically */
            color: #e2e8f0;
        }
        .flip-card-back {
            transform: rotateY(180deg);
            justify-content: flex-start; /* Align content to top */
        }

        /* Agulha do afinador */
        #needle {
            transform-origin: bottom center;
            transition: transform 0.2s ease-out;
        }
        /* Estilo para corda ativa/sugerida */
        .string-button.active {
            @apply ring-4; /* Anel para destacar */
        }
        /* Estilo para o volume meter */
        #volume-meter-bar {
            transition: width 0.1s ease-out;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .flip-card-front, .flip-card-back {
                padding: 1.5rem;
            }
            .note-display {
                font-size: 4rem;
            }
            .frequency-display {
                font-size: 1rem;
            }
            .string-buttons button {
                flex: 1 1 calc(50% - 0.5rem); /* 2 buttons per row on small screens */
                max-width: calc(50% - 0.5rem);
            }
        }

        /* Common styles for tuner elements */
        .tuner-bar-wrapper {
            background-color: #4a5568;
            border-radius: 0.75rem;
            height: 1rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        .tuner-indicator {
            position: absolute;
            width: 0.5rem;
            height: 100%;
            background-color: #48bb78;
            left: 50%;
            transform: translateX(-50%);
            transition: left 0.1s ease-out, background-color 0.2s ease-in-out;
            border-radius: 0.25rem;
        }
        .tuner-indicator.flat {
            background-color: #f56565;
        }
        .tuner-indicator.sharp {
            background-color: #f6ad55;
        }
        .tuner-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #a0aec0;
            margin-bottom: 2rem;
        }
        .note-display {
            font-size: 5rem;
            font-weight: 700;
            color: #63b3ed;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        .frequency-display {
            font-size: 1.25rem;
            color: #cbd5e0;
            margin-bottom: 2.5rem;
        }
        .string-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 1rem; /* Adjusted margin for spacing */
            margin-bottom: 1.5rem; /* Adjusted margin for spacing */
        }
        .string-buttons button {
            background-color: #4299e1;
            color: white;
            padding: 0.75rem 0;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            flex: 1 1 calc(33.33% - 0.5rem);
            max-width: calc(33.33% - 0.5rem);
            margin: 0.25rem;
            box-sizing: border-box;
        }
        .string-buttons button:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .string-buttons button.selected {
            background-color: #ecc94b;
            color: #2d3748;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
        }
        .control-buttons {
            margin-top: 1.5rem; /* Added margin for spacing */
        }
        .control-buttons button {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            width: 100%;
            margin-bottom: 1rem;
        }
        .control-buttons .start-button {
            background-color: #48bb78;
            color: white;
        }
        .control-buttons .start-button:hover {
            background-color: #38a169;
            transform: translateY(-2px);
        }
        .control-buttons .stop-button {
            background-color: #f56565;
            color: white;
        }
        .control-buttons .stop-button:hover {
            background-color: #e53e3e;
            transform: translateY(-2px);
        }
        .control-buttons .help-button {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        .control-buttons .help-button:hover {
            background-color: #2d3748;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="flip-container">
        <div class="flip-card-inner">
            <div class="flip-card-front">
                <h1 class="text-3xl font-bold text-teal-400 mb-6">Afinador de Violão</h1>

                <div id="status-message" class="h-10 flex items-center justify-center">
                    <p class="text-gray-400">Clique em "Iniciar Afinador" para começar</p>
                </div>

                <div class="relative w-full h-40 bg-gray-900/50 rounded-lg overflow-hidden flex items-end justify-center">
                    <!-- Linha central -->
                    <div id="center-line" class="absolute top-0 bottom-0 w-1 bg-gray-500/50" style="left: 50%; transform: translateX(-50%);"></div>
                    
                    <!-- Agulha do afinador -->
                    <div id="needle" class="absolute bottom-0 w-1 h-2/3 bg-gray-400 rounded-t-full" style="transform: rotate(0deg);"></div>

                    <!-- Indicadores de cents -->
                    <div class="absolute bottom-4 text-xs text-gray-400" style="left: 50%; transform: translateX(-50%);">0</div>
                    <div class="absolute bottom-4 text-xs text-gray-500" style="left: 25%; transform: translateX(-50%);">-50</div>
                    <div class="absolute bottom-4 text-xs text-gray-500" style="left: 75%; transform: translateX(-50%);">+50</div>

                    <!-- Volume Meter -->
                    <div class="absolute top-2 left-2 right-2 h-4 bg-gray-700 rounded-full overflow-hidden">
                        <div id="volume-meter-bar" class="h-full bg-blue-400 rounded-full" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="flex items-center justify-center space-x-2 mt-4">
                    <div id="note-name" class="text-8xl font-black text-white tracking-tighter">--</div>
                    <div class="flex flex-col text-left">
                        <div id="note-sharp-flat" class="text-2xl font-bold text-gray-400 h-8"></div>
                        <div id="note-octave" class="text-2xl font-bold text-gray-500"></div>
                    </div>
                </div>
                
                <div id="frequency-display" class="text-lg text-gray-400 h-6">Frequência: --- Hz</div>

                <div class="string-buttons">
                    <!-- Botões das cordas com IDs para fácil acesso -->
                    <button id="string-E2" class="string-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-2 rounded-lg transition-all duration-150 transform hover:scale-105">E2 (Mi)</button>
                    <button id="string-A2" class="string-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-2 rounded-lg transition-all duration-150 transform hover:scale-105">A2 (Lá)</button>
                    <button id="string-D3" class="string-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-2 rounded-lg transition-all duration-150 transform hover:scale-105">D3 (Ré)</button>
                    <button id="string-G3" class="string-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-2 rounded-lg transition-all duration-150 transform hover:scale-105">G3 (Sol)</button>
                    <button id="string-B3" class="string-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-2 rounded-lg transition-all duration-150 transform hover:scale-105">B3 (Si)</button>
                    <button id="string-E4" class="string-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-2 rounded-lg transition-all duration-150 transform hover:scale-105">E4 (Mi)</button>
                </div>

                <div class="control-buttons">
                    <button id="toggle-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-gray-900 font-bold py-4 px-4 rounded-xl transition-all duration-200 ease-in-out transform hover:scale-105 shadow-lg">
                        Iniciar Afinador
                    </button>

                    <button id="help-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-200 ease-in-out transform hover:scale-105 shadow-lg mt-3">
                        Ajuda
                    </button>
                </div>
            </div>

            <div class="flip-card-back">
                <h2 class="text-2xl font-bold text-blue-400 mb-4">Como Usar o Afinador</h2>
                <p class="text-left mb-2">
                    Este afinador de violão usa o microfone do seu dispositivo.
                </p>
                <ul class="list-disc list-inside text-gray-300 space-y-2 flex-grow">
                    <li>
                        <strong>Iniciar/Parar:</strong> Clique no botão "Iniciar Afinador" para ativar o microfone e começar a afinação. Clique em "Parar Afinador" para parar.
                    </li>
                    <li>
                        <strong>Sequência de Afinação:</strong> O afinador o guiará pela sequência padrão das cordas do violão (E2, A2, D3, G3, B3, E4). A corda atual a ser afinada estará destacada. Você também pode clicar nos botões das cordas para selecionar manualmente.
                    </li>
                    <li>
                        <strong>Indicador de Afinação:</strong> A agulha central indica o quão perto você está da afinação ideal.
                        <ul class="list-circle list-inside ml-4 mt-1">
                            <li>
                                <span class="text-green-400">Verde:</span> Corda afinada (dentro de +/- 5 cents).
                            </li>
                            <li>
                                <span class="text-red-400">Vermelho:</span> Corda muito grave ou nota incorreta.
                            </li>
                            <li>
                                <span class="text-orange-400">Laranja:</span> Corda muito aguda.
                            </li>
                            <li>
                                <span class="text-gray-400">Cinza:</span> Perto da afinação, mas ainda precisa de ajuste.
                            </li>
                        </ul>
                    </li>
                    <li>
                        <strong>Volume do Microfone:</strong> A barra azul no topo do afinador mostra o nível de volume captado pelo microfone.
                    </li>
                    <li>
                        <strong>Som de Afinado:</strong> Um som será emitido quando a corda estiver afinada.
                    </li>
                </ul>
                <button id="back-button" class="w-full bg-blue-500 hover:bg-blue-600 text-gray-900 font-bold py-3 px-4 rounded-xl transition-all duration-200 ease-in-out transform hover:scale-105 shadow-lg mt-4">
                    Voltar
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Elementos do DOM ---
        const flipContainer = document.querySelector('.flip-container');
        const noteNameEl = document.getElementById('note-name');
        const noteSharpFlatEl = document.getElementById('note-sharp-flat');
        const noteOctaveEl = document.getElementById('note-octave');
        const toggleBtn = document.getElementById('toggle-btn');
        const needle = document.getElementById('needle');
        const statusMessageEl = document.getElementById('status-message').querySelector('p');
        const frequencyDisplayEl = document.getElementById('frequency-display');
        const stringButtons = {
            'E2': document.getElementById('string-E2'),
            'A2': document.getElementById('string-A2'),
            'D3': document.getElementById('string-D3'),
            'G3': document.getElementById('string-G3'),
            'B3': document.getElementById('string-B3'),
            'E4': document.getElementById('string-E4')
        };
        const allStringButtons = document.querySelectorAll('.string-button');
        const volumeMeterBar = document.getElementById('volume-meter-bar');
        const helpBtn = document.getElementById('help-btn');
        const backButton = document.getElementById('back-button'); // New back button

        const centerLine = document.getElementById('center-line');

        // --- Variáveis de Áudio e Estado ---
        let audioContext;
        let analyser;
        let mediaStreamSource;
        let buffer;
        let isRunning = false;
        const noteStrings = ["Dó", "Dó♯", "Ré", "Ré♯", "Mi", "Fá", "Fá♯", "Sol", "Sol♯", "Lá", "Lá♯", "Si"];
        
        // Frequências padrão para violão (EADGBe)
        const guitarStrings = {
            'E2': { name: 'Mi', octave: 2, frequency: 82.41 }, // 6ª corda
            'A2': { name: 'Lá', octave: 2, frequency: 110.00 }, // 5ª corda
            'D3': { name: 'Ré', octave: 3, frequency: 146.83 }, // 4ª corda
            'G3': { name: 'Sol', octave: 3, frequency: 196.00 }, // 3ª corda
            'B3': { name: 'Si', octave: 3, frequency: 246.94 }, // 2ª corda
            'E4': { name: 'Mi', octave: 4, frequency: 329.63 }  // 1ª corda
        };
        
        const tuningSequence = ['E2', 'A2', 'D3', 'G3', 'B3', 'E4']; // Ordem de afinação
        let currentStringIndex = 0;
        let stringTunedState = { 'E2': false, 'A2': false, 'D3': false, 'G3': false, 'B3': false, 'E4': false };
        let tuningComplete = false;

        const CENTS_HISTORY_SIZE = 5;
        let centsHistory = [];

        // Cores específicas para cada corda (base e acento para anel/texto)
        const stringColors = {
            'E2': { base: 'red-500', accent: 'red-400' },
            'A2': { base: 'yellow-500', accent: 'yellow-400' },
            'D3': { base: 'blue-500', accent: 'blue-400' },
            'G3': { base: 'green-500', accent: 'green-400' },
            'B3': { base: 'purple-500', accent: 'purple-400' },
            'E4': { base: 'pink-500', accent: 'pink-400' }
        };

        // --- Funções Auxiliares de Áudio ---
        function playTunedSound() {
            if (audioContext) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // Tom de 880 Hz para indicar afinação
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                
                oscillator.start(audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.5); 
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }

        // --- Funções Principais ---
        async function toggleTuner() {
            if (isRunning) {
                stopTuner();
            } else {
                await startTuner();
            }
        }

        async function startTuner() {
            try {
                if (audioContext && audioContext.state === 'suspended') {
                    await audioContext.resume();
                } else if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                if (!stream.active) {
                    throw new Error('O stream do microfone não está ativo.');
                }

                mediaStreamSource = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                buffer = new Float32Array(analyser.fftSize);
                
                mediaStreamSource.connect(analyser);

                isRunning = true;
                updateUIOnStart();
                initializeTuningSequence(); // Inicia a sequência de afinação
                analysePitch();
                console.log('Afinador iniciado. Contexto de áudio:', audioContext.state);
            } catch (err) {
                console.error('Erro ao aceder ao microfone:', err);
                let errorMessage = 'Erro ao aceder ao microfone.';
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage = 'Acesso ao microfone negado. Por favor, permita o acesso ao microfone nas configurações do seu navegador.';
                } else if (err.name === 'NotFoundError') {
                    errorMessage = 'Nenhum microfone encontrado. Verifique se um microfone está conectado e funcionando.';
                } else if (err.name === 'NotReadableError') {
                    errorMessage = 'O microfone está a ser usado por outra aplicação. Por favor, feche-a e tente novamente.';
                }
                statusMessageEl.textContent = errorMessage;
                statusMessageEl.classList.add('text-red-400');
                toggleBtn.textContent = 'Iniciar Afinador';
                toggleBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                toggleBtn.classList.add('bg-teal-500', 'hover:bg-teal-600');
            }
        }

        function stopTuner() {
            if (mediaStreamSource) {
                mediaStreamSource.mediaStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) {
                audioContext.suspend();
            }
            isRunning = false;
            updateUIOnStop();
            centsHistory = [];
            console.log('Afinador parado. Contexto de áudio:', audioContext ? audioContext.state : 'fechado');
        }

        function analysePitch() {
            if (!isRunning || !analyser || !audioContext || audioContext.state !== 'running') return;

            analyser.getFloatTimeDomainData(buffer);

            let sumSquares = 0;
            for (let i = 0; i < buffer.length; i++) {
                sumSquares += buffer[i] * buffer[i];
            }
            const rms = Math.sqrt(sumSquares / buffer.length);
            
            // Atualiza o medidor de volume
            const volumeWidth = Math.min(100, rms * 500); // Multiplicador para ajustar a sensibilidade
            volumeMeterBar.style.width = `${volumeWidth}%`;

            const fundamentalFreq = getPitchAutoCorrelation(buffer, audioContext.sampleRate);

            if (fundamentalFreq > 0) {
                const noteData = getNoteData(fundamentalFreq);
                
                centsHistory.push(noteData.cents);
                if (centsHistory.length > CENTS_HISTORY_SIZE) {
                    centsHistory.shift();
                }
                const averagedCents = centsHistory.reduce((a, b) => a + b, 0) / centsHistory.length;

                updateUINote({ ...noteData, cents: averagedCents }, fundamentalFreq);
            } else {
                resetUINoteDisplay();
                statusMessageEl.textContent = 'Nenhuma nota detectada. Toque uma corda.';
                statusMessageEl.classList.remove('text-green-400', 'text-blue-400', 'text-red-400', 'text-yellow-400', 'text-purple-400', 'text-pink-400');
                statusMessageEl.classList.add('text-red-400');
                centsHistory = [];
            }
            
            requestAnimationFrame(analysePitch);
        }

        function getPitchAutoCorrelation(buffer, sampleRate) {
            const minFreq = 70; // Frequência mínima para violão
            const maxFreq = 400; // Frequência máxima para violão
            const minPeriod = sampleRate / maxFreq;
            const maxPeriod = sampleRate / minFreq;

            const n = buffer.length;
            const autoCorrelation = new Float32Array(n);

            for (let lag = 0; lag < n; lag++) {
                let sum = 0;
                for (let i = 0; i < n - lag; i++) {
                    sum += buffer[i] * buffer[i + lag];
                }
                autoCorrelation[lag] = sum;
            }

            let maxVal = -1;
            let peakIndex = -1;

            for (let i = Math.floor(minPeriod); i < Math.min(n, Math.ceil(maxPeriod)); i++) {
                if (autoCorrelation[i] > maxVal) {
                    maxVal = autoCorrelation[i];
                    peakIndex = i;
                }
            }

            if (peakIndex <= 0) {
                return -1;
            }

            let x0 = peakIndex - 1;
            let x1 = peakIndex;
            let x2 = peakIndex + 1;

            if (x0 < 0 || x2 >= n) {
                return sampleRate / peakIndex;
            }

            let s0 = autoCorrelation[x0];
            let s1 = autoCorrelation[x1];
            let s2 = autoCorrelation[x2];

            let shift = 0.5 * (s0 - s2) / (s0 - 2 * s1 + s2);
            let finalIndex = x1 + shift;

            if (finalIndex > 0) {
                return sampleRate / finalIndex;
            }
            return -1;
        }

        function getNoteData(frequency) {
            const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
            const roundedNoteNum = Math.round(noteNum) + 69;
            const idealFrequency = 440 * Math.pow(2, (roundedNoteNum - 69) / 12);
            const cents = 1200 * (Math.log(frequency / idealFrequency) / Math.log(2));
            
            return {
                name: noteStrings[roundedNoteNum % 12],
                octave: Math.floor(roundedNoteNum / 12) - 1,
                cents: cents
            };
        }

        // --- Funções de UI ---

        function updateUIOnStart() {
            toggleBtn.textContent = 'Parar Afinador';
            toggleBtn.classList.remove('bg-teal-500', 'hover:bg-teal-600');
            toggleBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            statusMessageEl.textContent = 'A ouvir...';
            statusMessageEl.classList.remove('text-red-400');
            tuningComplete = false;
        }

        function updateUIOnStop() {
            toggleBtn.textContent = 'Iniciar Afinador';
            toggleBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            toggleBtn.classList.add('bg-teal-500', 'hover:bg-teal-600');
            statusMessageEl.textContent = 'Clique em "Iniciar Afinador" para começar';
            resetUINoteDisplay();
            resetStringButtons(); // Reseta completamente os botões ao parar
            currentStringIndex = 0;
            tuningComplete = false;
            volumeMeterBar.style.width = '0%';
        }

        function resetUINoteDisplay() {
            noteNameEl.textContent = '--';
            noteSharpFlatEl.textContent = '';
            noteOctaveEl.textContent = '';
            needle.style.transform = 'rotate(0deg)';
            needle.style.backgroundColor = '#4a5568'; // gray-700
            noteNameEl.style.color = '#ffffff'; // white
            frequencyDisplayEl.textContent = 'Frequência: --- Hz';
            centerLine.classList.remove('bg-red-500/50', 'bg-yellow-500/50', 'bg-blue-500/50', 'bg-green-500/50', 'bg-purple-500/50', 'bg-pink-500/50');
            centerLine.classList.add('bg-gray-500/50');
        }

        /**
         * Reseta o estado visual de todos os botões das cordas.
         * Agora, as cordas afinadas permanecem com sua cor correspondente.
         */
        function resetStringButtons() {
            allStringButtons.forEach(button => {
                button.classList.remove('active'); // Sempre remove 'active'
                // Remove todas as classes de anel de cor
                button.classList.remove('ring-red-400', 'ring-yellow-400', 'ring-blue-400', 'ring-green-400', 'ring-purple-400', 'ring-pink-400'); 
                
                const stringKey = button.id.replace('string-', '');
                const currentColor = stringColors[stringKey] ? stringColors[stringKey].base : 'gray-700';

                // Se a corda NÃO estiver afinada, reseta para o estilo padrão cinza
                if (!button.classList.contains('tuned')) {
                    button.classList.remove('bg-red-500', 'bg-yellow-500', 'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500'); // Remove cores específicas
                    button.classList.add('bg-gray-700', 'hover:bg-gray-600', 'text-white');
                } else {
                    // Se a corda JÁ estiver afinada, garante que ela mantenha a cor base correspondente
                    button.classList.remove('bg-gray-700', 'hover:bg-gray-600'); // Remove cinza
                    button.classList.add(`bg-${currentColor}`); // Adiciona a cor base da corda
                    button.classList.add('text-white'); // Garante texto branco
                }
            });
        }

        function initializeTuningSequence() {
            stringTunedState = { 'E2': false, 'A2': false, 'D3': false, 'G3': false, 'B3': false, 'E4': false };
            resetStringButtons();
            currentStringIndex = 0;
            tuningComplete = false;
            highlightCurrentString();
        }

        function highlightCurrentString() {
            resetStringButtons(); // Remove o destaque 'active' das cordas anteriores

            if (currentStringIndex < tuningSequence.length) {
                const currentStringKey = tuningSequence[currentStringIndex];
                const currentColorAccent = stringColors[currentStringKey].accent;
                const currentBaseColor = stringColors[currentStringKey].base;

                stringButtons[currentStringKey].classList.add('active');
                stringButtons[currentStringKey].classList.add(`ring-${currentColorAccent}`);
                // Garante que o botão da corda atual tenha a cor base da corda, mesmo se não estiver afinado ainda
                stringButtons[currentStringKey].classList.remove('bg-gray-700', 'hover:bg-gray-600');
                stringButtons[currentStringKey].classList.add(`bg-${currentBaseColor}`);


                statusMessageEl.textContent = `Afine a corda ${guitarStrings[currentStringKey].name}${guitarStrings[currentStringKey].octave}`;
                statusMessageEl.classList.remove('text-red-400', 'text-yellow-400', 'text-blue-400', 'text-green-400', 'text-purple-400', 'text-pink-400', 'text-gray-400');
                statusMessageEl.classList.add(`text-${currentColorAccent}`);

                centerLine.classList.remove('bg-red-500/50', 'bg-yellow-500/50', 'bg-blue-500/50', 'bg-green-500/50', 'bg-purple-500/50', 'bg-pink-500/50', 'bg-gray-500/50');
                centerLine.classList.add(`bg-${currentColorAccent}/50`);

            } else {
                statusMessageEl.textContent = 'Violão Afinadíssimo! 🎉';
                statusMessageEl.classList.remove('text-red-400', 'text-yellow-400', 'text-blue-400', 'text-green-400', 'text-purple-400', 'text-pink-400', 'text-gray-400');
                statusMessageEl.classList.add('text-green-400');
                tuningComplete = true;
                centerLine.classList.remove('bg-red-500/50', 'bg-yellow-500/50', 'bg-blue-500/50', 'bg-green-500/50', 'bg-purple-500/50', 'bg-pink-500/50', 'bg-gray-500/50');
                centerLine.classList.add('bg-green-500/50');
            }
        }
        
        function updateUINote(noteData, frequency) {
            const currentStringKey = tuningSequence[currentStringIndex];
            const targetStringData = guitarStrings[currentStringKey];
            const currentStringColors = stringColors[currentStringKey];
            const currentAccentColor = currentStringColors ? currentStringColors.accent : 'gray-400';
            const currentBaseColor = currentStringColors ? currentStringColors.base : 'gray-700';


            noteNameEl.textContent = noteData.name.split('♯')[0];
            noteSharpFlatEl.textContent = noteData.name.split('♯').length > 1 ? '♯' : '';
            noteOctaveEl.textContent = noteData.octave;
            frequencyDisplayEl.textContent = `Frequência: ${frequency.toFixed(2)} Hz`;

            const clampedCents = Math.max(-50, Math.min(50, noteData.cents));
            const rotation = (clampedCents / 50) * 60; // Gira a agulha em 60 graus para +/- 50 cents
            needle.style.transform = `rotate(${rotation}deg)`;

            if (!tuningComplete) {
                if (noteData.name === targetStringData.name && noteData.octave === targetStringData.octave) {
                    if (Math.abs(clampedCents) < 5) { // Afinada (dentro de +/- 5 cents)
                        needle.style.backgroundColor = '#10b981'; // green-500
                        noteNameEl.style.color = '#10b981';
                        noteSharpFlatEl.style.color = '#10b981';
                        noteOctaveEl.style.color = '#10b981';

                        if (!stringTunedState[currentStringKey]) {
                            stringTunedState[currentStringKey] = true;
                            stringButtons[currentStringKey].classList.add('tuned');
                            stringButtons[currentStringKey].classList.remove('active');
                            stringButtons[currentStringKey].classList.remove(`ring-${currentAccentColor}`); // Remove a cor do anel
                            
                            // Aplica a cor base da corda ao botão quando afinada
                            stringButtons[currentStringKey].classList.remove('bg-gray-700', 'hover:bg-gray-600');
                            stringButtons[currentStringKey].classList.add(`bg-${currentBaseColor}`);
                            stringButtons[currentStringKey].classList.add('text-white'); // Garante texto branco

                            playTunedSound();
                            statusMessageEl.textContent = `Corda ${guitarStrings[currentStringKey].name} Afinada! ✅`;
                            statusMessageEl.classList.remove('text-red-400', 'text-yellow-400', 'text-blue-400', 'text-green-400', 'text-purple-400', 'text-pink-400', 'text-gray-400');
                            statusMessageEl.classList.add('text-green-400');

                            setTimeout(() => {
                                currentStringIndex++;
                                highlightCurrentString();
                                resetUINoteDisplay();
                            }, 1500); // Espera 1.5s antes de ir para a próxima corda
                        }
                    } else { // Perto, mas não afinada
                        needle.style.backgroundColor = `var(--tw-colors-${currentAccentColor.replace('-', '')})`;
                        noteNameEl.style.color = `var(--tw-colors-${currentAccentColor.replace('-', '')})`;
                        noteSharpFlatEl.style.color = `var(--tw-colors-${currentAccentColor.replace('-', '')})`;
                        noteOctaveEl.style.color = `var(--tw-colors-${currentAccentColor.replace('-', '')})`;

                        statusMessageEl.textContent = `Afine a corda ${guitarStrings[currentStringKey].name}${guitarStrings[currentStringKey].octave} (${clampedCents.toFixed(0)} cents)`;
                        statusMessageEl.classList.remove('text-red-400', 'text-yellow-400', 'text-blue-400', 'text-green-400', 'text-purple-400', 'text-pink-400', 'text-gray-400');
                        statusMessageEl.classList.add(`text-${currentAccentColor}`);
                    }
                } else { // Não é a corda atual ou está muito fora
                    needle.style.backgroundColor = '#f87171'; // red-400
                    noteNameEl.style.color = '#f87171';
                    noteSharpFlatEl.style.color = '#f87171';
                    noteOctaveEl.style.color = '#f87171';
                    statusMessageEl.textContent = `Procure a corda ${guitarStrings[currentStringKey].name}${guitarStrings[currentStringKey].octave}`;
                    statusMessageEl.classList.remove('text-red-400', 'text-yellow-400', 'text-blue-400', 'text-green-400', 'text-purple-400', 'text-pink-400', 'text-gray-400');
                    statusMessageEl.classList.add('text-red-400');
                }
            } else { // Modo cromático após todas as cordas estarem afinadas
                needle.style.backgroundColor = '#2dd4bf'; // teal-400 (cor neutra para modo cromático)
                noteNameEl.style.color = '#2dd4bf';
                noteSharpFlatEl.style.color = '#2dd4bf';
                noteOctaveEl.style.color = '#2dd4bf';
                // No modo cromático, o status exibe a nota detectada
                statusMessageEl.textContent = `Cromático: ${noteData.name}${noteData.octave} (${clampedCents.toFixed(0)} cents)`;
                statusMessageEl.classList.remove('text-red-400', 'text-yellow-400', 'text-blue-400', 'text-green-400', 'text-purple-400', 'text-pink-400', 'text-gray-400');
                statusMessageEl.classList.add('text-teal-400');
            }
        }

        // --- Event Listeners ---
        toggleBtn.addEventListener('click', toggleTuner);
        helpBtn.addEventListener('click', () => {
            flipContainer.classList.add('flipped'); // Flip the card to show help
        });
        backButton.addEventListener('click', () => { // New event listener for back button
            flipContainer.classList.remove('flipped'); // Flip the card back
        });

        // Adiciona listeners para os botões das cordas para permitir seleção manual
        allStringButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (isRunning) { // Só permite seleção manual se o afinador estiver ativo
                    const selectedStringKey = button.id.replace('string-', '');
                    const index = tuningSequence.indexOf(selectedStringKey);
                    if (index !== -1) {
                        currentStringIndex = index;
                        highlightCurrentString();
                        resetUINoteDisplay(); // Reseta o display para a nova corda selecionada
                        centsHistory = []; // Limpa o histórico de cents para a nova corda
                    }
                }
            });
        });

        // Inicialização ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            resetUINoteDisplay();
            resetStringButtons();
            // Inicializa o Tone.js para que esteja pronto para tocar sons
            initializeAudioSynth(); 
        });

    </script>
</body>
</html>
